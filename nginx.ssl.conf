#=========================================================================#
# Default Web Domain Template                                             #
# DO NOT MODIFY THIS FILE! CHANGES WILL BE LOST WHEN REBUILDING DOMAINS   #
# https://hestiacp.com/docs/server-administration/web-templates.html      #
#=========================================================================#

server {
        listen      144.202.77.18:443 ssl;
        server_name visitantes.cyberpol.com.py ;
        error_log   /var/log/apache2/domains/visitantes.cyberpol.com.py.error.log error;

        ssl_certificate     /home/cyberpol/conf/web/visitantes.cyberpol.com.py/ssl/visitantes.cyberpol.com.py.pem;
        ssl_certificate_key /home/cyberpol/conf/web/visitantes.cyberpol.com.py/ssl/visitantes.cyberpol.com.py.key;
        ssl_stapling        on;
        ssl_stapling_verify on;

        # TLS 1.3 0-RTT anti-replay
        if ($anti_replay = 307) { return 307 https://$host$request_uri; }
        if ($anti_replay = 425) { return 425; }

        include /home/cyberpol/conf/web/visitantes.cyberpol.com.py/nginx.hsts.conf*;

        location ~ /\.(?!well-known\/|file) {
                deny all;
                return 404;
        }

        location / {
                proxy_ssl_server_name on;
                proxy_ssl_name $host;
                proxy_pass http://144.202.77.18:3000;

                # Headers para pasar la IP real del cliente a Next.js (necesario para verificación VPN)
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                location ~* ^.+\.(css|htm|html|js|mjs|json|xml|apng|avif|bmp|cur|gif|ico|jfif|jpg|jpeg|pjp|pjpeg|png|svg|tif|tiff|webp|aac|caf|flac|m4a|midi|mp3|ogg|opus|wav|3gp|av1|avi|m4v|mkv|mov|mpg|mpeg|mp4|mp4v|webm|otf|ttf|woff|woff2|doc|docx|odf|odp|ods|odt|pdf|ppt|pptx|rtf|txt|xls|xlsx|7z|bz2|gz|rar|tar|tgz|zip|apk|appx|bin|dmg|exe|img|iso|jar|msi|webmanifest)$ {
                        try_files  $uri @fallback;

                        root       /home/cyberpol/web/visitantes.cyberpol.com.py/public_html;
                        access_log /var/log/apache2/domains/visitantes.cyberpol.com.py.log combined;
                        access_log /var/log/apache2/domains/visitantes.cyberpol.com.py.bytes bytes;

                        expires    max;
                }
        }

        location @fallback {
                proxy_ssl_server_name on;
                proxy_ssl_name $host;
                proxy_pass http://144.202.77.18:3000;

                # Headers para pasar la IP real del cliente a Next.js (necesario para verificación VPN)
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /error/ {
                alias /home/cyberpol/web/visitantes.cyberpol.com.py/document_errors/;
        }

        proxy_hide_header Upgrade;

        include /home/cyberpol/conf/web/visitantes.cyberpol.com.py/nginx.ssl.conf_*;
}

